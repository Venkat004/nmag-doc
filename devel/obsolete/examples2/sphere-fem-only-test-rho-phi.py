import nmag
from nmag import SI,mesh
import nmesh 
import os,sys

H_x = SI(0.0e6, "A/m") 
H_y = SI(0.0e6, "A/m") 
H_z = SI(0.0e6, "A/m") 

intensive_param_by_name={"H_x":H_x, "H_y":H_y, "H_z":H_z}

mat_Py = nmag.MagMaterial(name="Py",
                          Ms=SI(1e6,"A/m"),
                          exchange_coupling=SI(13.0e-12, "J/m")
                          )

sim = nmag.Simulation("sphere", fem_only=True)
unit_length = SI(1e-9,"m")

meshfile = "sphere-test-rho-phi2.nmesh"
sim.load_mesh(meshfile, [("void",[]),("Py", mat_Py)], unit_length=unit_length)

def initial_magnetization((x, y, z), mag_type):
    return [1, 0, 0]

sim.set_magnetization(initial_magnetization)

sim.compute_H_fields()
sim.fun_update_energies([])

sim.save_field('m','m-sphere-fem-only.nvf')
sim.save_data_table()

default_val = 1e-99

f = open("probe-sphere-fem-only-test-rho-phi.dat", "w")
f.write("x_coords\tm_x\tm_y\tm_z\tm_x\th_demag_x\th_demag_y\th_demag_z\trho\tphi\n")

for p_x in range(-1000,1001):

    rho = sim._get_from_field(
        sim.fields['rho'],
        'rho',
        pos=[p_x*0.1,0.0,0.0],
        name='rho',
        units=SI(1,"A/m^2"),
        pos_units=unit_length,
        si_units=SI(1,"A/m^2"))

    if rho==None:
        rho = default_val
    
    phi = sim._get_from_field(
        sim.fields['phi'],
        'phi',
        pos=[p_x*0.1,0.0,0.0],
        name='phi',
        units=SI(1,"A"),
        pos_units=unit_length,
        si_units=SI(1,"A"))
    if phi==None:
        phi = default_val
        
    h_demag = sim.get_H_demag(pos=[p_x*0.1,0.0,0.0],pos_unit=unit_length)
    if h_demag == None:
        hx,hy,hz = 3*[default_val]
    else:
        hx,hy,hz = h_demag

    magnetization = sim.get_M([p_x*0.1,0.0,0.0],name="Py",pos_unit=unit_length)
    if magnetization == None:
        mx,my,mz = 3*[default_val]
    else: mx,my,mz = magnetization
    f.write("%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f\n" % (p_x*0.1, mx, my,mz, hx, hy, hz, rho, phi))

f.close()
sim.save_fields_vtk('sphere-fem-only-test-rho-phi.vtk')

"""
-10.000000 0.000000 0.000000 0.000000 148804.548984 -1482.915301 -2999.376465
-9.900000 1000000.000000 0.000000 0.000000 96614.842108 -1098.409282 -2362.007206
-9.800000 1000000.000000 0.000000 0.000000 43635.784520 -1087.627703 -2097.289742
-9.700000 1000000.000000 0.000000 0.000000 -9343.273069 -1076.846123 -1832.572277
-9.600000 1000000.000000 0.000000 0.000000 -62322.330658 -1066.064544 -1567.854812
-9.500000 1000000.000000 0.000000 0.000000 -115301.388247 -1055.282965 -1303.137348
-9.400000 1000000.000000 0.000000 0.000000 -168280.445835 -1044.501385 -1038.419883
-9.300000 1000000.000000 0.000000 0.000000 -221259.503424 -1033.719806 -773.702418
-9.200000 1000000.000000 0.000000 0.000000 -274238.561013 -1022.938226 -508.984954
-9.100000 1000000.000000 0.000000 0.000000 -328967.463502 -1114.531174 441.475132
-9.000000 1000000.000000 0.000000 0.000000 -329752.412773 -1014.995924 420.222674
-8.900000 1000000.000000 0.000000 0.000000 -329816.477135 -897.852780 339.984245
-8.800000 1000000.000000 0.000000 0.000000 -329880.541497 -780.709636 259.745816
-8.700000 1000000.000000 0.000000 0.000000 -329944.605859 -663.566491 179.507387
-8.600000 1000000.000000 0.000000 0.000000 -330008.670221 -546.423347 99.268958
-8.500000 1000000.000000 0.000000 0.000000 -330062.088516 -435.599139 34.032291
-8.400000 1000000.000000 0.000000 0.000000 -330072.248785 -350.450581 29.752086
-8.300000 1000000.000000 0.000000 0.000000 -330114.181768 -290.190891 25.428785
-8.200000 1000000.000000 0.000000 0.000000 -330166.493714 -238.061468 21.091405
-8.100000 1000000.000000 0.000000 0.000000 -330185.545008 -187.550978 22.115052
-8.000000 1000000.000000 0.000000 0.000000 -330180.360283 -141.048389 26.750353
-7.900000 1000000.000000 0.000000 0.000000 -330176.480971 -102.466752 30.343090
-7.800000 1000000.000000 0.000000 0.000000 -330172.601658 -63.885115 33.935828
-7.700000 1000000.000000 0.000000 0.000000 -330168.722345 -25.303478 37.528566
-7.600000 1000000.000000 0.000000 0.000000 -330165.082395 11.824435 40.802417
-7.500000 1000000.000000 0.000000 0.000000 -330166.059911 20.909014 37.924713
-7.400000 1000000.000000 0.000000 0.000000 -330167.037428 29.993594 35.047009
-7.300000 1000000.000000 0.000000 0.000000 -330168.014944 39.078173 32.169305
-7.200000 1000000.000000 0.000000 0.000000 -330168.992460 48.162753 29.291600
-7.100000 1000000.000000 0.000000 0.000000 -330153.802868 59.225057 27.141277
-7.000000 1000000.000000 0.000000 0.000000 -330142.808324 66.071307 19.889599
-6.900000 1000000.000000 0.000000 0.000000 -330131.813780 72.917557 12.637921
-6.800000 1000000.000000 0.000000 0.000000 -330120.819237 79.763807 5.386243
-6.700000 1000000.000000 0.000000 0.000000 -330105.695524 80.062149 3.202036
-6.600000 1000000.000000 0.000000 0.000000 -330090.178757 79.737198 1.500200
-6.500000 1000000.000000 0.000000 0.000000 -330076.211870 80.044199 -0.432300
-6.400000 1000000.000000 0.000000 0.000000 -330064.200698 82.630064 -3.138440
-6.300000 1000000.000000 0.000000 0.000000 -330053.076925 86.841253 -6.388232
-6.200000 1000000.000000 0.000000 0.000000 -330042.371931 91.095895 -9.645598
-6.100000 1000000.000000 0.000000 0.000000 -330033.065320 93.274083 -12.519194
-6.000000 1000000.000000 0.000000 0.000000 -330025.172576 92.887223 -14.919038
-5.900000 1000000.000000 0.000000 0.000000 -330017.279831 92.500364 -17.318882
-5.800000 1000000.000000 0.000000 0.000000 -330006.114363 92.860983 -19.349255
-5.700000 1000000.000000 0.000000 0.000000 -329995.750313 92.313734 -21.062267
-5.600000 1000000.000000 0.000000 0.000000 -329985.275462 91.706444 -23.443679
-5.500000 1000000.000000 0.000000 0.000000 -329974.195932 91.319325 -26.389693
-5.400000 1000000.000000 0.000000 0.000000 -329962.620627 91.186098 -29.346033
-5.300000 1000000.000000 0.000000 0.000000 -329952.315171 90.958415 -31.877522
-5.200000 1000000.000000 0.000000 0.000000 -329944.393682 90.553401 -33.611412
-5.100000 1000000.000000 0.000000 0.000000 -329936.472194 90.148387 -35.345302
-5.000000 1000000.000000 0.000000 0.000000 -329928.307847 89.493806 -37.056299
-4.900000 1000000.000000 0.000000 0.000000 -329920.129844 88.825192 -38.766008
-4.800000 1000000.000000 0.000000 0.000000 -329911.766325 88.077594 -40.320088
-4.700000 1000000.000000 0.000000 0.000000 -329901.956471 86.714208 -40.660845
-4.600000 1000000.000000 0.000000 0.000000 -329894.066935 84.555478 -41.011774
-4.500000 1000000.000000 0.000000 0.000000 -329887.765245 81.739105 -41.371115
-4.400000 1000000.000000 0.000000 0.000000 -329881.349719 80.167646 -42.376543
-4.300000 1000000.000000 0.000000 0.000000 -329874.917786 78.775618 -43.475092
-4.200000 1000000.000000 0.000000 0.000000 -329868.485853 77.383591 -44.573641
-4.100000 1000000.000000 0.000000 0.000000 -329862.053920 75.991563 -45.672190
-4.000000 1000000.000000 0.000000 0.000000 -329855.613533 74.642496 -46.766013
-3.900000 1000000.000000 0.000000 0.000000 -329849.978082 73.790374 -47.530691
-3.800000 1000000.000000 0.000000 0.000000 -329845.804998 72.712003 -48.093949
-3.700000 1000000.000000 0.000000 0.000000 -329841.633640 71.631503 -48.658435
-3.600000 1000000.000000 0.000000 0.000000 -329837.462283 70.551003 -49.222921
-3.500000 1000000.000000 0.000000 0.000000 -329833.290926 69.470503 -49.787407
-3.400000 1000000.000000 0.000000 0.000000 -329828.869505 67.777057 -49.841395
-3.300000 1000000.000000 0.000000 0.000000 -329824.350766 65.845067 -49.696709
-3.200000 1000000.000000 0.000000 0.000000 -329819.918311 64.041093 -49.878518
-3.100000 1000000.000000 0.000000 0.000000 -329815.660029 62.495534 -50.719392
-3.000000 1000000.000000 0.000000 0.000000 -329811.401747 60.949976 -51.560266
-2.900000 1000000.000000 0.000000 0.000000 -329807.864394 59.721729 -51.419718
-2.800000 1000000.000000 0.000000 0.000000 -329804.390568 58.521443 -51.192688
-2.700000 1000000.000000 0.000000 0.000000 -329800.916743 57.321157 -50.965658
-2.600000 1000000.000000 0.000000 0.000000 -329797.623483 56.013098 -51.209501
-2.500000 1000000.000000 0.000000 0.000000 -329794.567277 54.592212 -51.446770
-2.400000 1000000.000000 0.000000 0.000000 -329792.195008 52.846751 -51.644365
-2.300000 1000000.000000 0.000000 0.000000 -329789.822740 51.101291 -51.841961
-2.200000 1000000.000000 0.000000 0.000000 -329787.450471 49.355830 -52.039556
-2.100000 1000000.000000 0.000000 0.000000 -329785.119723 47.597221 -52.178790
-2.000000 1000000.000000 0.000000 0.000000 -329782.808447 45.832446 -52.290652
-1.900000 1000000.000000 0.000000 0.000000 -329780.469224 43.794339 -52.245478
-1.800000 1000000.000000 0.000000 0.000000 -329778.010212 42.430851 -52.124332
-1.700000 1000000.000000 0.000000 0.000000 -329775.535084 41.202283 -52.007247
-1.600000 1000000.000000 0.000000 0.000000 -329774.155705 39.900458 -51.821335
-1.500000 1000000.000000 0.000000 0.000000 -329772.858160 38.808771 -51.837436
-1.400000 1000000.000000 0.000000 0.000000 -329771.563887 37.728499 -51.864512
-1.300000 1000000.000000 0.000000 0.000000 -329770.297986 36.544222 -51.893894
-1.200000 1000000.000000 0.000000 0.000000 -329769.087123 35.158188 -51.927752
-1.100000 1000000.000000 0.000000 0.000000 -329767.876260 33.772154 -51.961609
-1.000000 1000000.000000 0.000000 0.000000 -329766.665397 32.386120 -51.995467
-0.900000 1000000.000000 0.000000 0.000000 -329766.102056 31.167938 -52.016855
-0.800000 1000000.000000 0.000000 0.000000 -329765.690995 29.989231 -52.035309
-0.700000 1000000.000000 0.000000 0.000000 -329765.279934 28.810525 -52.053764
-0.600000 1000000.000000 0.000000 0.000000 -329764.813422 27.671552 -52.094409
-0.500000 1000000.000000 0.000000 0.000000 -329764.211726 26.629449 -52.189152
-0.400000 1000000.000000 0.000000 0.000000 -329763.630172 25.529910 -52.234498
-0.300000 1000000.000000 0.000000 0.000000 -329763.153037 24.132633 -52.023775
-0.200000 1000000.000000 0.000000 0.000000 -329762.695664 22.790521 -51.832917
-0.100000 1000000.000000 0.000000 0.000000 -329762.406780 21.918748 -51.811429
0.000000 1000000.000000 0.000000 0.000000 -329762.072199 21.030019 -51.741837
0.100000 1000000.000000 0.000000 0.000000 -329762.007089 19.951803 -51.781607
0.200000 1000000.000000 0.000000 0.000000 -329761.867590 18.848040 -51.920424
0.300000 1000000.000000 0.000000 0.000000 -329761.728091 17.744277 -52.059241
0.400000 1000000.000000 0.000000 0.000000 -329761.588591 16.640513 -52.198059
0.500000 1000000.000000 0.000000 0.000000 -329761.449092 15.536750 -52.336876
0.600000 1000000.000000 0.000000 0.000000 -329761.375696 14.508834 -52.456697
0.700000 1000000.000000 0.000000 0.000000 -329761.734180 13.976460 -52.452403
0.800000 1000000.000000 0.000000 0.000000 -329762.092664 13.444085 -52.448109
0.900000 1000000.000000 0.000000 0.000000 -329762.552744 12.796894 -52.550040
1.000000 1000000.000000 0.000000 0.000000 -329763.231974 11.902034 -52.881104
1.100000 1000000.000000 0.000000 0.000000 -329763.911203 11.007175 -53.212168
1.200000 1000000.000000 0.000000 0.000000 -329764.590433 10.112316 -53.543233
1.300000 1000000.000000 0.000000 0.000000 -329765.335537 9.194036 -53.702053
1.400000 1000000.000000 0.000000 0.000000 -329766.712033 8.510654 -53.754679
1.500000 1000000.000000 0.000000 0.000000 -329768.095015 7.861671 -53.825196
1.600000 1000000.000000 0.000000 0.000000 -329769.477997 7.212688 -53.895714
1.700000 1000000.000000 0.000000 0.000000 -329770.860979 6.563704 -53.966231
1.800000 1000000.000000 0.000000 0.000000 -329772.212239 5.863007 -54.070359
1.900000 1000000.000000 0.000000 0.000000 -329773.411860 4.915104 -54.335153
2.000000 1000000.000000 0.000000 0.000000 -329774.611481 3.967201 -54.599947
2.100000 1000000.000000 0.000000 0.000000 -329777.275392 2.790945 -55.284490
2.200000 1000000.000000 0.000000 0.000000 -329780.134080 1.604517 -56.009766
2.300000 1000000.000000 0.000000 0.000000 -329782.711566 0.921610 -56.310848
2.400000 1000000.000000 0.000000 0.000000 -329785.289052 0.238703 -56.611930
2.500000 1000000.000000 0.000000 0.000000 -329787.866538 -0.444203 -56.913012
2.600000 1000000.000000 0.000000 0.000000 -329790.444024 -1.127110 -57.214093
2.700000 1000000.000000 0.000000 0.000000 -329793.423327 -1.567712 -57.604154
2.800000 1000000.000000 0.000000 0.000000 -329797.117125 -2.077039 -57.562741
2.900000 1000000.000000 0.000000 0.000000 -329801.249002 -2.697493 -57.175343
3.000000 1000000.000000 0.000000 0.000000 -329805.380880 -3.317947 -56.787945
3.100000 1000000.000000 0.000000 0.000000 -329809.970221 -4.658593 -57.280714
3.200000 1000000.000000 0.000000 0.000000 -329814.643806 -6.131865 -57.935569
3.300000 1000000.000000 0.000000 0.000000 -329819.316963 -7.502279 -58.336722
3.400000 1000000.000000 0.000000 0.000000 -329823.989765 -8.787624 -58.528047
3.500000 1000000.000000 0.000000 0.000000 -329828.662567 -10.072969 -58.719372
3.600000 1000000.000000 0.000000 0.000000 -329833.797118 -10.722044 -59.268102
3.700000 1000000.000000 0.000000 0.000000 -329840.292533 -11.173952 -59.212386
3.800000 1000000.000000 0.000000 0.000000 -329846.977800 -11.634877 -59.036263
3.900000 1000000.000000 0.000000 0.000000 -329853.663067 -12.095802 -58.860140
4.000000 1000000.000000 0.000000 0.000000 -329859.919688 -13.712102 -60.065754
4.100000 1000000.000000 0.000000 0.000000 -329866.139028 -15.428893 -61.391547
4.200000 1000000.000000 0.000000 0.000000 -329875.031399 -15.686018 -61.843300
4.300000 1000000.000000 0.000000 0.000000 -329885.052069 -15.327010 -61.926117
4.400000 1000000.000000 0.000000 0.000000 -329895.191913 -15.543249 -61.641680
4.500000 1000000.000000 0.000000 0.000000 -329905.559018 -16.856459 -60.656901
4.600000 1000000.000000 0.000000 0.000000 -329915.926124 -18.169670 -59.672122
4.700000 1000000.000000 0.000000 0.000000 -329926.293229 -19.482881 -58.687343
4.800000 1000000.000000 0.000000 0.000000 -329936.660335 -20.796092 -57.702564
4.900000 1000000.000000 0.000000 0.000000 -329948.150885 -22.453525 -57.149387
5.000000 1000000.000000 0.000000 0.000000 -329964.363439 -25.288077 -57.007918
5.100000 1000000.000000 0.000000 0.000000 -329980.289958 -27.999537 -56.817476
5.200000 1000000.000000 0.000000 0.000000 -329996.216478 -30.710998 -56.627033
5.300000 1000000.000000 0.000000 0.000000 -330012.142997 -33.422458 -56.436591
5.400000 1000000.000000 0.000000 0.000000 -330028.069517 -36.133919 -56.246148
5.500000 1000000.000000 0.000000 0.000000 -330043.996036 -38.845379 -56.055706
5.600000 1000000.000000 0.000000 0.000000 -330060.520172 -39.916725 -56.655940
5.700000 1000000.000000 0.000000 0.000000 -330079.898348 -40.712330 -56.802772
5.800000 1000000.000000 0.000000 0.000000 -330103.470585 -41.977098 -55.793962
5.900000 1000000.000000 0.000000 0.000000 -330127.042823 -43.241866 -54.785151
6.000000 1000000.000000 0.000000 0.000000 -330150.615060 -44.506634 -53.776340
6.100000 1000000.000000 0.000000 0.000000 -330174.187298 -45.771402 -52.767530
6.200000 1000000.000000 0.000000 0.000000 -330197.759536 -47.036170 -51.758719
6.300000 1000000.000000 0.000000 0.000000 -330221.331773 -48.300938 -50.749908
6.400000 1000000.000000 0.000000 0.000000 -330244.904011 -49.565706 -49.741098
6.500000 1000000.000000 0.000000 0.000000 -330267.641624 -50.857266 -48.559126
6.600000 1000000.000000 0.000000 0.000000 -330301.301801 -55.916392 -43.569015
6.700000 1000000.000000 0.000000 0.000000 -330337.632106 -62.223457 -39.823717
6.800000 1000000.000000 0.000000 0.000000 -330373.962411 -68.530523 -36.078420
6.900000 1000000.000000 0.000000 0.000000 -330410.292716 -74.837588 -32.333123
7.000000 1000000.000000 0.000000 0.000000 -330446.623021 -81.144654 -28.587825
7.100000 1000000.000000 0.000000 0.000000 -330482.953325 -87.451720 -24.842528
7.200000 1000000.000000 0.000000 0.000000 -330519.283630 -93.758785 -21.097231
7.300000 1000000.000000 0.000000 0.000000 -330555.613935 -100.065851 -17.351933
7.400000 1000000.000000 0.000000 0.000000 -330591.944240 -106.372916 -13.606636
7.500000 1000000.000000 0.000000 0.000000 -330628.274545 -112.679982 -9.861339
7.600000 1000000.000000 0.000000 0.000000 -330671.657834 -115.016877 -2.178799
7.700000 1000000.000000 0.000000 0.000000 -330724.759001 -106.908479 9.190277
7.800000 1000000.000000 0.000000 0.000000 -330777.860168 -98.800081 20.559352
7.900000 1000000.000000 0.000000 0.000000 -330830.961335 -90.691683 31.928427
8.000000 1000000.000000 0.000000 0.000000 -330891.034965 -88.482764 33.151362
8.100000 1000000.000000 0.000000 0.000000 -330963.592586 -96.836692 16.207927
8.200000 1000000.000000 0.000000 0.000000 -331036.150207 -105.190620 -0.735509
8.300000 1000000.000000 0.000000 0.000000 -331110.942698 -111.296132 -12.873713
8.400000 1000000.000000 0.000000 0.000000 -331194.035567 -109.050959 -7.165144
8.500000 1000000.000000 0.000000 0.000000 -331277.128436 -106.805786 -1.456575
8.600000 1000000.000000 0.000000 0.000000 -331360.221304 -104.560613 4.251994
8.700000 1000000.000000 0.000000 0.000000 -331443.314173 -102.315440 9.960564
8.800000 1000000.000000 0.000000 0.000000 -331557.806423 -107.144651 42.779761
8.900000 1000000.000000 0.000000 0.000000 -331684.007094 -95.424896 61.674434
9.000000 1000000.000000 0.000000 0.000000 -331811.011258 -78.251616 74.204952
9.100000 1000000.000000 0.000000 0.000000 -331938.015422 -61.078336 86.735470
9.200000 1000000.000000 0.000000 0.000000 -293831.358614 -80.655038 285.653615
9.300000 1000000.000000 0.000000 0.000000 -248624.053656 -107.056843 519.187148
9.400000 1000000.000000 0.000000 0.000000 -203416.748699 -133.458649 752.720681
9.500000 1000000.000000 0.000000 0.000000 -158209.443742 -159.860454 986.254214
9.600000 1000000.000000 0.000000 0.000000 -113002.138785 -186.262260 1219.787746
9.700000 1000000.000000 0.000000 0.000000 -67794.833828 -212.664065 1453.321279
9.800000 1000000.000000 0.000000 0.000000 -22587.528871 -239.065870 1686.854812
9.900000 1000000.000000 0.000000 0.000000 22619.776087 -265.467676 1920.388344
10.000000 1000000.000000 0.000000 0.000000 67827.081044 -291.869481 2153.921877

"""
