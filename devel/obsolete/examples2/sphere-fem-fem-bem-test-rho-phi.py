import nmag
from nmag import SI,mesh
import nmesh 
import os

H_x = SI(0.0e6, "A/m") 
H_y = SI(0.0e6, "A/m") 
H_z = SI(0.0e6, "A/m") 

intensive_param_by_name={"H_x":H_x, "H_y":H_y, "H_z":H_z}

mat_Py = nmag.MagMaterial(name="Py",
                          Ms=SI(1e6,"A/m"),
                          exchange_coupling=SI(13.0e-12, "J/m")
                          )

sim = nmag.Simulation("sphere", fem_only=False)
unit_length = SI(1e-9,"m")

meshfile = "sphere-test-rho-phi2.nmesh"
sim.load_mesh(meshfile,  [("void",[]),("Py", mat_Py)], unit_length=unit_length)

def initial_magnetization((x, y, z), mag_type):
        return  [1, 0, 0]

sim.set_magnetization(initial_magnetization)

sim.compute_H_fields()
sim.fun_update_energies([])

sim.save_field('m','m-sphere-fem-fem-bem.nvf')
sim.save_data_table()

default_val = 1e-99

f = open("probe-sphere-fem-fem-bem-test-rho-phi.dat", "w")
f.write("x_coords\tm_x\tm_y\tm_z\tm_x\th_demag_x\th_demag_y\th_demag_z\trho\tphi\n")

for p_x in range(-1000,1001):

    rho = sim._get_from_field(
        sim.fields['rho'],
        'rho',
        pos=[p_x*0.1,0.0,0.0],
        name='rho',
        units=SI(1,"A/m^2"),
        pos_units=unit_length,
        si_units=SI(1,"A/m^2"))

    if rho==None:
        rho = default_val
    
    phi = sim._get_from_field(
        sim.fields['phi'],
        'phi',
        pos=[p_x*0.1,0.0,0.0],
        name='phi',
        units=SI(1,"A"),
        pos_units=unit_length,
        si_units=SI(1,"A"))
    if phi==None:
        phi = default_val
        
    h_demag = sim.get_H_demag(pos=[p_x*0.1,0.0,0.0],pos_unit=unit_length)
    if h_demag == None:
        hx,hy,hz = 3*[default_val]
    else:
        hx,hy,hz = h_demag

    magnetization = sim.get_M([p_x*0.1,0.0,0.0],name="Py",pos_unit=unit_length)
    if magnetization == None:
        mx,my,mz = 3*[default_val]
    else: mx,my,mz = magnetization
    f.write("%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f\n" % (p_x*0.1, mx, my,mz, hx, hy, hz, rho, phi))

f.close()
sim.save_fields_vtk('sphere-fem-fem-bem-test-rho-phi.vtk')


"""
-10.000000 0.000000 0.000000 0.000000 148474.826648 -1481.046030 -2998.625907
-9.900000 1000000.000000 0.000000 0.000000 96284.854690 -1096.528086 -2361.344593
-9.800000 1000000.000000 0.000000 0.000000 43305.481402 -1085.729601 -2096.725678
-9.700000 1000000.000000 0.000000 0.000000 -9673.891885 -1074.931116 -1832.106764
-9.600000 1000000.000000 0.000000 0.000000 -62653.265172 -1064.132630 -1567.487849
-9.500000 1000000.000000 0.000000 0.000000 -115632.638459 -1053.334145 -1302.868934
-9.400000 1000000.000000 0.000000 0.000000 -168612.011747 -1042.535660 -1038.250020
-9.300000 1000000.000000 0.000000 0.000000 -221591.385034 -1031.737175 -773.631105
-9.200000 1000000.000000 0.000000 0.000000 -274570.758321 -1020.938690 -509.012190
-9.100000 1000000.000000 0.000000 0.000000 -329299.973034 -1112.508402 441.343057
-9.000000 1000000.000000 0.000000 0.000000 -330085.267077 -1012.969549 420.070574
-8.900000 1000000.000000 0.000000 0.000000 -330149.709456 -895.837038 339.821840
-8.800000 1000000.000000 0.000000 0.000000 -330214.151834 -778.704528 259.573107
-8.700000 1000000.000000 0.000000 0.000000 -330278.594212 -661.572018 179.324373
-8.600000 1000000.000000 0.000000 0.000000 -330343.036590 -544.439508 99.075639
-8.500000 1000000.000000 0.000000 0.000000 -330396.822316 -433.616129 33.830557
-8.400000 1000000.000000 0.000000 0.000000 -330407.307003 -348.428565 29.549617
-8.300000 1000000.000000 0.000000 0.000000 -330449.358984 -288.149643 25.230687
-8.200000 1000000.000000 0.000000 0.000000 -330501.722826 -236.007447 20.899347
-8.100000 1000000.000000 0.000000 0.000000 -330520.768082 -185.553082 21.952108
-8.000000 1000000.000000 0.000000 0.000000 -330515.527577 -139.151409 26.652566
-7.900000 1000000.000000 0.000000 0.000000 -330511.573508 -100.652702 30.363845
-7.800000 1000000.000000 0.000000 0.000000 -330507.619438 -62.153995 34.075123
-7.700000 1000000.000000 0.000000 0.000000 -330503.665368 -23.655288 37.786401
-7.600000 1000000.000000 0.000000 0.000000 -330499.942306 13.392676 41.177746
-7.500000 1000000.000000 0.000000 0.000000 -330500.675540 22.454822 38.397368
-7.400000 1000000.000000 0.000000 0.000000 -330501.408774 31.516968 35.616990
-7.300000 1000000.000000 0.000000 0.000000 -330502.142008 40.579114 32.836612
-7.200000 1000000.000000 0.000000 0.000000 -330502.875242 49.641260 30.056234
-7.100000 1000000.000000 0.000000 0.000000 -330487.335080 60.652974 28.028825
-7.000000 1000000.000000 0.000000 0.000000 -330475.985825 67.425548 20.878293
-6.900000 1000000.000000 0.000000 0.000000 -330464.636570 74.198123 13.727762
-6.800000 1000000.000000 0.000000 0.000000 -330453.287315 80.970697 6.577230
-6.700000 1000000.000000 0.000000 0.000000 -330438.285166 81.265788 4.441121
-6.600000 1000000.000000 0.000000 0.000000 -330422.935300 80.944289 2.782334
-6.500000 1000000.000000 0.000000 0.000000 -330409.101731 81.224756 0.896203
-6.400000 1000000.000000 0.000000 0.000000 -330397.189490 83.744070 -1.681827
-6.300000 1000000.000000 0.000000 0.000000 -330386.152233 87.869681 -4.735463
-6.200000 1000000.000000 0.000000 0.000000 -330375.527371 92.027779 -7.792393
-6.100000 1000000.000000 0.000000 0.000000 -330366.423111 94.013033 -10.460056
-6.000000 1000000.000000 0.000000 0.000000 -330358.886373 93.323251 -12.650253
-5.900000 1000000.000000 0.000000 0.000000 -330351.349636 92.633470 -14.840449
-5.800000 1000000.000000 0.000000 0.000000 -330340.349741 92.779724 -16.893460
-5.700000 1000000.000000 0.000000 0.000000 -330330.038488 92.122652 -18.506949
-5.600000 1000000.000000 0.000000 0.000000 -330319.335155 91.573970 -20.899392
-5.500000 1000000.000000 0.000000 0.000000 -330307.718636 91.419726 -23.989939
-5.400000 1000000.000000 0.000000 0.000000 -330295.513958 91.564849 -27.130172
-5.300000 1000000.000000 0.000000 0.000000 -330284.652091 91.557812 -29.774322
-5.200000 1000000.000000 0.000000 0.000000 -330276.311164 91.265113 -31.487144
-5.100000 1000000.000000 0.000000 0.000000 -330267.970237 90.972414 -33.199965
-5.000000 1000000.000000 0.000000 0.000000 -330259.360495 90.394848 -34.947791
-4.900000 1000000.000000 0.000000 0.000000 -330250.735638 89.801263 -36.697585
-4.800000 1000000.000000 0.000000 0.000000 -330241.928226 89.124884 -38.293510
-4.700000 1000000.000000 0.000000 0.000000 -330231.697577 87.803011 -38.689836
-4.600000 1000000.000000 0.000000 0.000000 -330223.406597 85.726810 -39.084285
-4.500000 1000000.000000 0.000000 0.000000 -330216.719465 83.026884 -39.477183
-4.400000 1000000.000000 0.000000 0.000000 -330210.005724 81.505485 -40.525200
-4.300000 1000000.000000 0.000000 0.000000 -330203.288147 80.153949 -41.667641
-4.200000 1000000.000000 0.000000 0.000000 -330196.570570 78.802414 -42.810083
-4.100000 1000000.000000 0.000000 0.000000 -330189.852994 77.450878 -43.952524
-4.000000 1000000.000000 0.000000 0.000000 -330183.132160 76.139106 -45.092779
-3.900000 1000000.000000 0.000000 0.000000 -330177.391217 75.258898 -45.919812
-3.800000 1000000.000000 0.000000 0.000000 -330173.296496 74.125159 -46.474019
-3.700000 1000000.000000 0.000000 0.000000 -330169.203620 72.989411 -47.029059
-3.600000 1000000.000000 0.000000 0.000000 -330165.110744 71.853663 -47.584099
-3.500000 1000000.000000 0.000000 0.000000 -330161.017868 70.717915 -48.139139
-3.400000 1000000.000000 0.000000 0.000000 -330156.657706 68.954768 -48.192011
-3.300000 1000000.000000 0.000000 0.000000 -330152.193523 66.947452 -48.049451
-3.200000 1000000.000000 0.000000 0.000000 -330147.847965 65.095190 -48.236635
-3.100000 1000000.000000 0.000000 0.000000 -330143.741865 63.555920 -49.089444
-3.000000 1000000.000000 0.000000 0.000000 -330139.635764 62.016649 -49.942252
-2.900000 1000000.000000 0.000000 0.000000 -330136.430801 60.717194 -49.880347
-2.800000 1000000.000000 0.000000 0.000000 -330133.305246 59.438872 -49.737836
-2.700000 1000000.000000 0.000000 0.000000 -330130.179691 58.160550 -49.595326
-2.600000 1000000.000000 0.000000 0.000000 -330127.127366 56.881842 -49.864980
-2.500000 1000000.000000 0.000000 0.000000 -330124.345987 55.480349 -50.126173
-2.400000 1000000.000000 0.000000 0.000000 -330122.352121 53.720549 -50.344742
-2.300000 1000000.000000 0.000000 0.000000 -330120.358255 51.960749 -50.563312
-2.200000 1000000.000000 0.000000 0.000000 -330118.364389 50.200950 -50.781881
-2.100000 1000000.000000 0.000000 0.000000 -330116.406713 48.444158 -50.966161
-2.000000 1000000.000000 0.000000 0.000000 -330114.466009 46.688778 -51.134361
-1.900000 1000000.000000 0.000000 0.000000 -330112.563415 44.647022 -51.148500
-1.800000 1000000.000000 0.000000 0.000000 -330110.616947 43.415429 -51.031850
-1.700000 1000000.000000 0.000000 0.000000 -330108.659618 42.341571 -50.910269
-1.600000 1000000.000000 0.000000 0.000000 -330107.343127 41.028128 -50.748694
-1.500000 1000000.000000 0.000000 0.000000 -330106.144132 39.832477 -50.828243
-1.400000 1000000.000000 0.000000 0.000000 -330104.950809 38.643433 -50.920846
-1.300000 1000000.000000 0.000000 0.000000 -330103.796384 37.378388 -51.013664
-1.200000 1000000.000000 0.000000 0.000000 -330102.717415 35.965913 -51.106899
-1.100000 1000000.000000 0.000000 0.000000 -330101.638447 34.553438 -51.200133
-1.000000 1000000.000000 0.000000 0.000000 -330100.559478 33.140964 -51.293368
-0.900000 1000000.000000 0.000000 0.000000 -330099.948211 31.879249 -51.356587
-0.800000 1000000.000000 0.000000 0.000000 -330099.446936 30.652990 -51.412746
-0.700000 1000000.000000 0.000000 0.000000 -330098.945661 29.426731 -51.468906
-0.600000 1000000.000000 0.000000 0.000000 -330098.402138 28.220935 -51.546942
-0.500000 1000000.000000 0.000000 0.000000 -330097.755620 27.065024 -51.678309
-0.400000 1000000.000000 0.000000 0.000000 -330097.113683 25.879200 -51.762204
-0.300000 1000000.000000 0.000000 0.000000 -330096.495501 24.538310 -51.600006
-0.200000 1000000.000000 0.000000 0.000000 -330095.902071 23.233966 -51.447346
-0.100000 1000000.000000 0.000000 0.000000 -330095.519667 22.241206 -51.376008
0.000000 1000000.000000 0.000000 0.000000 -330095.117461 21.204735 -51.270749
0.100000 1000000.000000 0.000000 0.000000 -330094.976045 20.038553 -51.295384
0.200000 1000000.000000 0.000000 0.000000 -330094.810185 18.841647 -51.404826
0.300000 1000000.000000 0.000000 0.000000 -330094.644325 17.644740 -51.514269
0.400000 1000000.000000 0.000000 0.000000 -330094.478465 16.447834 -51.623711
0.500000 1000000.000000 0.000000 0.000000 -330094.312605 15.250927 -51.733154
0.600000 1000000.000000 0.000000 0.000000 -330094.197661 14.128854 -51.815727
0.700000 1000000.000000 0.000000 0.000000 -330094.415367 13.495700 -51.722756
0.800000 1000000.000000 0.000000 0.000000 -330094.633073 12.862546 -51.629785
0.900000 1000000.000000 0.000000 0.000000 -330094.943781 12.116664 -51.637081
1.000000 1000000.000000 0.000000 0.000000 -330095.455099 11.127621 -51.860657
1.100000 1000000.000000 0.000000 0.000000 -330095.966417 10.138578 -52.084234
1.200000 1000000.000000 0.000000 0.000000 -330096.477734 9.149535 -52.307811
1.300000 1000000.000000 0.000000 0.000000 -330097.062392 8.180658 -52.368722
1.400000 1000000.000000 0.000000 0.000000 -330098.206221 7.459166 -52.368823
1.500000 1000000.000000 0.000000 0.000000 -330099.350815 6.776893 -52.386947
1.600000 1000000.000000 0.000000 0.000000 -330100.495409 6.094619 -52.405071
1.700000 1000000.000000 0.000000 0.000000 -330101.640003 5.412346 -52.423195
1.800000 1000000.000000 0.000000 0.000000 -330102.754270 4.688960 -52.478939
1.900000 1000000.000000 0.000000 0.000000 -330103.723568 3.769049 -52.714521
2.000000 1000000.000000 0.000000 0.000000 -330104.692865 2.849137 -52.950102
2.100000 1000000.000000 0.000000 0.000000 -330107.033147 1.648845 -53.628876
2.200000 1000000.000000 0.000000 0.000000 -330109.556291 0.431298 -54.352032
2.300000 1000000.000000 0.000000 0.000000 -330111.827398 -0.276423 -54.658569
2.400000 1000000.000000 0.000000 0.000000 -330114.098506 -0.984144 -54.965106
2.500000 1000000.000000 0.000000 0.000000 -330116.369614 -1.691865 -55.271643
2.600000 1000000.000000 0.000000 0.000000 -330118.640721 -2.399585 -55.578180
2.700000 1000000.000000 0.000000 0.000000 -330121.363834 -2.863964 -55.988526
2.800000 1000000.000000 0.000000 0.000000 -330124.901994 -3.415742 -56.002780
2.900000 1000000.000000 0.000000 0.000000 -330128.941448 -4.092933 -55.693989
3.000000 1000000.000000 0.000000 0.000000 -330132.980902 -4.770124 -55.385197
3.100000 1000000.000000 0.000000 0.000000 -330137.641679 -6.157239 -55.839205
3.200000 1000000.000000 0.000000 0.000000 -330142.416874 -7.675089 -56.433687
3.300000 1000000.000000 0.000000 0.000000 -330147.240648 -9.099305 -56.797208
3.400000 1000000.000000 0.000000 0.000000 -330152.104599 -10.446081 -56.969713
3.500000 1000000.000000 0.000000 0.000000 -330156.968551 -11.792856 -57.142217
3.600000 1000000.000000 0.000000 0.000000 -330162.285020 -12.444157 -57.718082
3.700000 1000000.000000 0.000000 0.000000 -330169.086876 -12.860320 -57.772804
3.800000 1000000.000000 0.000000 0.000000 -330176.099259 -13.283172 -57.717606
3.900000 1000000.000000 0.000000 0.000000 -330183.111642 -13.706024 -57.662408
4.000000 1000000.000000 0.000000 0.000000 -330189.717066 -15.250191 -58.993738
4.100000 1000000.000000 0.000000 0.000000 -330196.287093 -16.891887 -60.445663
4.200000 1000000.000000 0.000000 0.000000 -330205.511839 -17.068856 -61.025514
4.300000 1000000.000000 0.000000 0.000000 -330215.857153 -16.627557 -61.237260
4.400000 1000000.000000 0.000000 0.000000 -330226.362804 -16.761392 -61.047557
4.500000 1000000.000000 0.000000 0.000000 -330237.174208 -17.991988 -60.092305
4.600000 1000000.000000 0.000000 0.000000 -330247.985613 -19.222584 -59.137053
4.700000 1000000.000000 0.000000 0.000000 -330258.797018 -20.453180 -58.181801
4.800000 1000000.000000 0.000000 0.000000 -330269.608422 -21.683776 -57.226549
4.900000 1000000.000000 0.000000 0.000000 -330281.486525 -23.277877 -56.722824
5.000000 1000000.000000 0.000000 0.000000 -330297.866435 -26.123085 -56.653268
5.100000 1000000.000000 0.000000 0.000000 -330313.957014 -28.847649 -56.539118
5.200000 1000000.000000 0.000000 0.000000 -330330.047594 -31.572212 -56.424967
5.300000 1000000.000000 0.000000 0.000000 -330346.138173 -34.296775 -56.310817
5.400000 1000000.000000 0.000000 0.000000 -330362.228752 -37.021339 -56.196667
5.500000 1000000.000000 0.000000 0.000000 -330378.319331 -39.745902 -56.082516
5.600000 1000000.000000 0.000000 0.000000 -330395.088132 -40.763985 -56.701539
5.700000 1000000.000000 0.000000 0.000000 -330414.692643 -41.507015 -56.841092
5.800000 1000000.000000 0.000000 0.000000 -330438.417617 -42.756973 -55.815453
5.900000 1000000.000000 0.000000 0.000000 -330462.142590 -44.006930 -54.789814
6.000000 1000000.000000 0.000000 0.000000 -330485.867564 -45.256887 -53.764175
6.100000 1000000.000000 0.000000 0.000000 -330509.592538 -46.506844 -52.738535
6.200000 1000000.000000 0.000000 0.000000 -330533.317512 -47.756801 -51.712896
6.300000 1000000.000000 0.000000 0.000000 -330557.042485 -49.006759 -50.687257
6.400000 1000000.000000 0.000000 0.000000 -330580.767459 -50.256716 -49.661618
6.500000 1000000.000000 0.000000 0.000000 -330603.659544 -51.518753 -48.466856
6.600000 1000000.000000 0.000000 0.000000 -330637.304367 -56.532841 -43.460782
6.700000 1000000.000000 0.000000 0.000000 -330673.591347 -62.798074 -39.686608
6.800000 1000000.000000 0.000000 0.000000 -330709.878327 -69.063307 -35.912433
6.900000 1000000.000000 0.000000 0.000000 -330746.165307 -75.328539 -32.138258
7.000000 1000000.000000 0.000000 0.000000 -330782.452287 -81.593772 -28.364084
7.100000 1000000.000000 0.000000 0.000000 -330818.739267 -87.859005 -24.589909
7.200000 1000000.000000 0.000000 0.000000 -330855.026247 -94.124238 -20.815734
7.300000 1000000.000000 0.000000 0.000000 -330891.313227 -100.389470 -17.041560
7.400000 1000000.000000 0.000000 0.000000 -330927.600207 -106.654703 -13.267385
7.500000 1000000.000000 0.000000 0.000000 -330963.887187 -112.919936 -9.493210
7.600000 1000000.000000 0.000000 0.000000 -331007.201083 -115.238559 -1.812895
7.700000 1000000.000000 0.000000 0.000000 -331060.213699 -107.138273 9.486145
7.800000 1000000.000000 0.000000 0.000000 -331113.226314 -99.037986 20.785184
7.900000 1000000.000000 0.000000 0.000000 -331166.238930 -90.937700 32.084223
8.000000 1000000.000000 0.000000 0.000000 -331226.206666 -88.753590 33.238292
8.100000 1000000.000000 0.000000 0.000000 -331298.627343 -97.162222 16.228085
8.200000 1000000.000000 0.000000 0.000000 -331371.048020 -105.570854 -0.782121
8.300000 1000000.000000 0.000000 0.000000 -331445.711999 -111.730413 -12.955067
8.400000 1000000.000000 0.000000 0.000000 -331528.707665 -109.536846 -7.162276
8.500000 1000000.000000 0.000000 0.000000 -331611.703332 -107.343280 -1.369486
8.600000 1000000.000000 0.000000 0.000000 -331694.698998 -105.149713 4.423304
8.700000 1000000.000000 0.000000 0.000000 -331777.694665 -102.956146 10.216094
8.800000 1000000.000000 0.000000 0.000000 -331892.008899 -107.872656 43.055171
8.900000 1000000.000000 0.000000 0.000000 -332017.824054 -96.186496 61.816687
9.000000 1000000.000000 0.000000 0.000000 -332144.388548 -79.028045 74.174506
9.100000 1000000.000000 0.000000 0.000000 -332270.953041 -61.869594 86.532325
9.200000 1000000.000000 0.000000 0.000000 -294164.229832 -81.422500 285.434347
9.300000 1000000.000000 0.000000 0.000000 -248956.927797 -107.793336 518.980834
9.400000 1000000.000000 0.000000 0.000000 -203749.625762 -134.164172 752.527321
9.500000 1000000.000000 0.000000 0.000000 -158542.323727 -160.535008 986.073807
9.600000 1000000.000000 0.000000 0.000000 -113335.021691 -186.905844 1219.620294
9.700000 1000000.000000 0.000000 0.000000 -68127.719656 -213.276680 1453.166781
9.800000 1000000.000000 0.000000 0.000000 -22920.417621 -239.647516 1686.713268
9.900000 1000000.000000 0.000000 0.000000 22286.884414 -266.018352 1920.259755
10.000000 1000000.000000 0.000000 0.000000 67494.186449 -292.389188 2153.806242
"""
